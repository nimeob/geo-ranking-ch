#!/usr/bin/env bash
set -euo pipefail

SCRIPT_DIR="$(cd -- "$(dirname -- "${BASH_SOURCE[0]}")" && pwd)"
TOKEN="$($SCRIPT_DIR/gh_app_token.sh)"

REMOTE_URL="$(git remote get-url origin)"
if [[ "$REMOTE_URL" =~ ^https:// ]]; then
  remote_without_scheme="${REMOTE_URL#https://}"
  if [[ "$remote_without_scheme" == *@* ]]; then
    remote_host_and_path="${remote_without_scheme#*@}"
  else
    remote_host_and_path="$remote_without_scheme"
  fi
  AUTH_URL="https://x-access-token:${TOKEN}@${remote_host_and_path}"
else
  echo "origin is not HTTPS ($REMOTE_URL). Please switch origin to https for app-token push." >&2
  exit 1
fi

BRANCH="$(git rev-parse --abbrev-ref HEAD)"

if [[ "$#" -eq 0 ]]; then
  exec git push "$AUTH_URL" "$BRANCH"
fi

# Remove a single literal "origin" argument for compatibility
args=()
removed=0
for a in "$@"; do
  if [[ $removed -eq 0 && "$a" == "origin" ]]; then
    removed=1
    continue
  fi
  args+=("$a")
done

if [[ "${#args[@]}" -eq 0 ]]; then
  exec git push "$AUTH_URL" "$BRANCH"
else
  exec git push "$AUTH_URL" "${args[@]}"
fi
