name: bl20-sequencer

on:
  issues:
    types: [closed]
  workflow_dispatch:
    inputs:
      closed_issue_number:
        description: "Optional: simulate a just-closed issue number"
        required: false
        type: number

permissions:
  issues: write

jobs:
  advance-sequence:
    runs-on: ubuntu-latest
    steps:
      - name: Advance BL-20 issue sequence
        uses: actions/github-script@v7
        with:
          script: |
            const sequence = [
              22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38,
            ];
            const parentIssue = 6;

            const eventClosedIssue = context.payload.issue?.number;
            const manualClosedIssue = Number(core.getInput('closed_issue_number') || 0);
            const closedIssueNumber = manualClosedIssue || eventClosedIssue;

            if (!closedIssueNumber) {
              core.info('No closed issue number available. Nothing to do.');
              return;
            }

            const idx = sequence.indexOf(closedIssueNumber);
            if (idx === -1) {
              core.info(`Issue #${closedIssueNumber} is not part of BL-20 sequence. Nothing to do.`);
              return;
            }

            let nextIssueNumber = null;
            for (let i = idx + 1; i < sequence.length; i += 1) {
              const n = sequence[i];
              const { data: issue } = await github.rest.issues.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: n,
              });
              if (issue.state === 'open') {
                nextIssueNumber = n;
                break;
              }
            }

            if (!nextIssueNumber) {
              core.info('No further open BL-20 issue in sequence. Nothing to unlock.');
              return;
            }

            const { data: nextIssue } = await github.rest.issues.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: nextIssueNumber,
            });

            const labels = (nextIssue.labels || []).map((l) => (typeof l === 'string' ? l : l.name));
            const desired = Array.from(new Set([
              ...labels.filter((l) => l && l !== 'status:blocked'),
              'status:todo',
            ]));

            await github.rest.issues.setLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: nextIssueNumber,
              labels: desired,
            });

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: parentIssue,
              body: `üîÅ BL-20 Sequencer: #${closedIssueNumber} wurde geschlossen ‚Üí #${nextIssueNumber} wurde auf \`status:todo\` gesetzt.`,
            });

            core.info(`Unlocked BL-20 issue #${nextIssueNumber}.`);
